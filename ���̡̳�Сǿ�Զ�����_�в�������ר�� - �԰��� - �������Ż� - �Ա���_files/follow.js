/*pub-1|2013-11-28 16:47:30*/SNS.define(["../friendfollow.css"],function(){var i=KISSY,q=i.DOM,n=i.Event;var j=null;var W=null;var e={update:N};i.mix(e,i.EventTarget);var u=location.host.indexOf(".taobao.net")===-1;var p="friend-follow-config";var Q=600;var w=300;var G=100;var A=null;var g=U();var f=u?"http://jianghu.taobao.com":"http://jianghu.daily.taobao.net";var m=f+"/admin/follow/follow.htm?_input_charset=utf8";var c=f+"/admin/follow/unFollow.htm?_input_charset=utf8";var h=f+"/admin/follow/json/batchQueryFollows.htm?_input_charset=utf8";function M(D){D=D||document;s(".J_FriendFollow","click",function(S){S.preventDefault();var E=this;J(E);if(!y(E)||q.data(E,"friend-follow-changed")){v(E)}B(E)},D);s(".J_FriendUnfollow","click",function(S){S.preventDefault();var E=this;k(E)},D);s(".J_FriendFollow","mouseover",function(E){var S=this;W=this;A&&A.cancel();if(y(S)){A=i.later(function(){B(S)},w)}},D);s(".J_FriendFollow","mouseout",O,D)}function P(D){}function B(D){SNS.require(["sns/widget/follow/group"],function(E){j=E;t();B=E.popupGroup;P=E.closeGroup;E.popupGroup(D)})}function t(){j.initGroup();j.on("mouseover",function(D){A&&A.cancel()});j.on("mouseout",O);j.on("change",function(D){if(J(W,D.group)){q.data(W,"friend-follow-changed",true)}else{q.removeData(W,"friend-follow-changed")}e.fire("change",D)});j.on("close",function(E){var D=E.target;var X=q.data(D,"friend-follow-changed");if(!X){L(D);return}var Y=E.group;var S=q.data(D,"data-group-old");if(S===Y){L(D);return}v(D,Y)})}function a(){n.on(document,"mouseover",T)}function O(X){var S=X.relatedTarget;var D=d(S,".J_FriendFollow");var E=d(S,".friend-follow-group");if(D||E){return}A&&A.cancel();A=i.later(function(){P()},G)}function v(D){q.removeData(D,"friend-follow-changed");var X=q.attr(D,"data-group");var S={user_id:q.attr(D,"data-userid")||"",groupIds:X};if(!q.hasClass(D,"friend-followed")){new Image().src="http://gm.mmstat.com/sns.3.5.1?cache="+new Date().getTime();if(X){new Image().src="http://gm.mmstat.com/sns.14.5?cache="+new Date().getTime()}}else{new Image().src="http://gm.mmstat.com/sns.14.6?cache="+new Date().getTime()}var E=q.hasClass(D,"friend-followed");x(D,S,function(Y){l(D,Y.isTwoWay===true||Y.isTwoWay==="true");j&&j.changeGroupInfo(Y);e.fire("follow",{target:D,newfollow:!E})})}function x(D,E,S){H(function(){var X=q.attr(D,"data-custom")||"";i.mix(E,KISSY.unparam(X));q.addClass(D,"friend-following2");E.ua=g&&g.ua();SNS.ajax({url:m,type:"post",data:E,dataType:"html",success:function(Z){delete E.TPL_checkcode;var Y=Z;if(i.isString(Z)){Z=KISSY.trim(Z);if(Z.charAt(0)=="<"){SNS.require(["sns/widget/follow/answer"],function(ac){ac.answer(Z,function(ad){x(D,ad,S)},function(){L(D)})});return}else{if(Z.charAt(0)=="{"){Y=i.JSON.parse(Z)}else{L(D);var ab=Z;V(D,ab)}}}if(Y.codeFlag){new Image().src="http://gm.mmstat.com/sns.11."+Y.codeFlag}if(Y.showCheckCode=="true"){SNS.require(["sns/widget/follow/checkcode"],function(ac){ac.checkcode(D,Y.url,Y.msg,function(ad){E.TPL_checkcode=ad;x(D,E,S)},function(){L(D)})});return}if(Y.isSuccess==0){S&&S(Y)}else{if(Y.isLogin==="false"){var aa=location.href.indexOf("taobao.net")>-1?"http://login.daily.taobao.net":"http://login.taobao.com";location.href=aa+"/member/login.jhtml?redirectURL="+encodeURIComponent(location.href);return}else{L(D)}}if(Y.isSuccess==-1||Y.status==15){var ab=Y.msg;V(D,ab)}},error:function(Z,Y,ab){L(D);var aa=Z;V(D,aa)}})})}function V(S,X){var E=q.data(S,p)||{};var D=q.get(E.container||document.body);SNS.require(["sns/widget/follow/error"],function(Z){var Y=Z.showErrorMsg(S,X,undefined,D)})}function k(E){var D=q.attr(E,"data-userid");H(function(){var S={user_id:D};SNS.ajax({url:c,type:"post",data:S,dataType:"json",success:function(X){if(X&&X.isSuccess==0){q.hide(E);e.fire("unfollow",{target:E})}else{if(X.isLogin==="false"){var Y=location.href.indexOf("taobao.net")>-1?"http://login.daily.taobao.net":"http://login.taobao.com";location.href=Y+"/member/login.jhtml?redirectURL="+encodeURIComponent(location.href);return}else{var Z=X&&X.msg;V(E,Z)}}}})})}function N(D){if(!SNS.checkLogin()){return}D=D||".J_FriendFollow";var E=[];q.query(D).each(function(X){var S=q.attr(X,"data-userid");i.indexOf(S,E)==-1&&E.push(S)});if(E.length===0){return}SNS.ajax({url:h,type:"get",data:{followingIds:E.join(",")},dataType:"json",success:function(S){var X=S.followList;q.query(D).each(function(aa){var Y=q.attr(aa,"data-userid");for(var Z=0;Z<X.length;Z++){var ab=X[Z];if(Y==ab.userId){if(ab.isFollow===true||ab.isFollow==="true"){F(aa,"friend-followed")}else{F(aa,"friend-follow",true)}if(ab.isFans===true||ab.isFans==="true"){q.attr(aa,"data-fans","true");q.addClass(aa,"friend-followed2")}else{q.removeAttr(aa,"data-fans");q.removeClass(aa,"friend-followed2")}aa.setAttribute("data-group",ab.group);aa.innerHTML=ab.showName;break}}});if(D===".J_FriendFollow"){q.query(".J_FriendUnfollow").each(function(aa){var Y=q.attr(aa,"data-userid");for(var Z=0;Z<X.length;Z++){var ab=X[Z];if(Y==ab.userId){if(ab.isFollow===true||ab.isFollow==="true"){q.show(aa)}else{q.hide(aa)}}}})}}})}var r=R();function R(){return i.Cookie.get("_l_g_")&&i.Cookie.get("_nk_")}function H(D){if(!SNS.checkLogin()){SNS.login(function(){b();D&&D()});return}else{D&&D()}}function T(){var D=R();if(D&&r!==D){b()}}function b(){r=R();N();j&&j.changeUser();return true}function K(S){var X=q.attr(S,"data-group");var Y="\u52a0\u5173\u6ce8";if(y(S)){var E=q.data(S,p)||{};if(E.blankGroupName){Y=E.blankGroupName}else{if(q.attr(S,"data-fans")){Y="\u76f8\u4e92\u5173\u6ce8"}else{Y="\u5df2\u5173\u6ce8"}}}if(!X){return Y}var D=X.split(",");if(D.length===0||D.length===1&&D[0]===""){return Y}else{if(D.length>1){return D.length+"\u4e2a\u7ec4\u5185"}else{return j&&j.getGroupName(D[0])||Y}}}function y(D){return q.hasClass(D,"friend-followed")}function F(E,D,S){if(y(E)&&!S){q.removeClass(E,"friend-following2");return}q.removeClass(E,"friend-follow");q.removeClass(E,"friend-following");q.removeClass(E,"friend-following2");q.removeClass(E,"friend-followed");q.removeClass(E,"friend-followed2");q.addClass(E,D);if(D=="friend-followed"&&q.attr(E,"data-fans")){q.addClass(E,"friend-followed2")}}function J(S,Y){var D=q.data(S,"data-group-old");if(D===undefined){var E=q.attr(S,"data-group")||"";q.data(S,"data-group-old",E);D=I(E)}F(S,"friend-following");var X=Y;if(X===undefined){X=q.attr(S,"data-group")||""}q.attr(S,"data-group",X);S.innerHTML=K(S);return X!==(D||"")}function L(D){F(D,"friend-follow");if(y(D)){var S=q.data(D,"data-group-old");q.attr(D,"data-group",S);D.innerHTML=K(D)}else{D.innerHTML="\u52a0\u5173\u6ce8";q.attr(D,"data-group","")}try{q.removeData(D,"data-group-old")}catch(E){q.removeAttr(D,"data-group-old")}}function l(E,D){F(E,"friend-followed");q.removeData(E,"data-group-old");if(D){q.attr(E,"data-fans","true");q.addClass(E,"friend-followed2")}E.innerHTML=K(E)}function s(D,S,X,E){if(i.UA.ie<=8&&S==="mouseout"&&(!E||E===document)){C(D,S,X,E);return}E=E||document;n.on(E,S,function(Y){var Z=d(Y.target,D);if(Z){X.call(Z,Y)}})}function C(D,S,X,E){i.later(function(){i.each(q.children(document.body),function(Y){if(!Y.hackFriendFollowSlash&&Y!==q.get("#site-nav")){try{s(D,S,X,Y);Y.hackFriendFollowSlash=true}catch(Z){}}})},500,true)}function d(E,D){if(D.charAt(0)=="."&&q.hasClass(E,D.slice(1))||E&&E.tagName===D){return E}return q.parent(E,D)}function I(E){var D=E.split(",");D.sort();return D.join(",")}function z(){e.on("follow",function(E){var D=E.target;q.query(".J_FriendFollow").each(function(S){var Y=q.attr(D,"data-group");var X=q.html(D);if(S!==D&&q.attr(S,"data-userid")===q.attr(D,"data-userid")){F(S,"friend-followed");q.attr(S,"data-group",Y);q.html(S,X);if(q.attr(D,"data-fans")){q.addClass(S,"friend-followed2");q.attr(S,"data-fans","true")}}});q.query(".J_FriendUnfollow").each(function(S){if(S!==D&&q.attr(S,"data-userid")===q.attr(D,"data-userid")){q.show(S)}})});e.on("unfollow",function(E){var D=E.target;q.query(".J_FriendFollow").each(function(S){if(S!==D&&q.attr(S,"data-userid")===q.attr(D,"data-userid")){F(S,"friend-follow",true);q.attr(S,"data-group","");q.html(S,"\u52a0\u5173\u6ce8")}});q.query(".J_FriendUnfollow").each(function(S){if(S!==D&&q.attr(S,"data-userid")===q.attr(D,"data-userid")){q.hide(S)}})})}var o={};o.on=function(D,E,S){q.query(D||document).each(function(X){e.on(E,function(Y){if(q.contains(X,Y.target)||X==Y.target){S&&S(Y)}})})};o.bindHover=function(D,E){j.on("show",function(S){D(S)});j.on("close",function(S){E(S)})};o.changeSkin=function(D,E){q.query(D).each(function(S){q.addClass(S,"friend-follow-skin-"+E);var X=q.get(".J_FriendFollow",S);o.config(X,{skin:E,groupSkin:E})})};o.update=N;o.setButton=function(D){W=D};o.config=function(D,S){var E=q.data(D,p);S=i.merge(E,S||{});S.container=S.container||S.srcNode;q.data(D,p,S)};o.configContainer=function(D){};i.ready(function(){a();M();z();g.init();if(!q.get(".friend-content")&&location.pathname.indexOf("opendocs_sdk.php")==-1){N()}});function U(){return{init:function(){if(!window.UA_Opt||!window.ua){window.UA_Opt=window.UA_Opt||{LogVal:"ua",MaxMCLog:3,MaxMPLog:3,MaxKSLog:3,Token:new Date().getTime()+":"+Math.random(),SendMethod:8,Flag:14222};window.ua="";i.getScript("http://acjs.aliyun.com/actionlog/js/ua.js",function(){try{UA_Opt.reload()}catch(D){}},"GBK")}},ua:function(){var D=window.ua;UA_Opt.Token=new Date().getTime()+":"+Math.random();UA_Opt.reload();return D}}}return o});